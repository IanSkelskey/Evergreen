<eg-title i18n-prefix prefix="Add Patrons to Bucket">
</eg-title>

<eg-staff-banner bannerText="Add Patrons to Bucket (Legacy Mode)" i18n-bannerText>
</eg-staff-banner>

<eg-progress-dialog #progressDialog></eg-progress-dialog>
<eg-alert-dialog #alertDialog></eg-alert-dialog>
<eg-patron-search-dialog #patronSearchDialog i18n-dialogTitle dialogTitle="Patron Search">
</eg-patron-search-dialog>

<div class="container-fluid px-0">
  <!-- Legacy notice with enhanced visuals -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="alert alert-warning border-warning">
        <div class="d-flex align-items-center">
          <span class="material-icons legacy-icon me-3">history</span>
          <div>
            <h5 class="mb-1" i18n>Legacy Feature</h5>
            <p class="mb-1" i18n>This is a legacy feature that queues patrons before adding them to a bucket. For most use cases, the newer methods are more efficient:</p>
            <ul class="mb-0 mt-2">
              <li i18n><strong>"Search & Add Patrons"</strong> - For adding multiple patrons through search</li>
              <li i18n><strong>"Quick Add"</strong> - For scanning individual patron barcodes</li>
              <li i18n><strong>"Upload Barcode File"</strong> - For uploading a file of patron barcodes</li>
            </ul>
            <div class="mt-2">
              <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary" i18n>
                <span class="material-icons">arrow_back</span>
                Return to Bucket Content
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bucket header section -->
  <div class="row mb-3">
    <div class="col-md-9">
      <div class="d-flex align-items-center">
        <h3 class="my-0 me-3">{{bucket?.name() || 'Select a Bucket'}}</h3>
        <!-- Owner information if available -->
        <span class="me-3 text-muted" *ngIf="bucket?.owner()">
          <span i18n>Owner:</span>
          <a href="/eg2/staff/circ/patron/{{bucket?.owner().id}}/edit" 
            target="_blank" class="ms-1">
            {{bucket?.owner().usrname}}
          </a>
        </span>
      </div>
      <div *ngIf="bucket?.description()" class="mt-2">
        <p class="text-muted mb-0">{{bucket?.description()}}</p>
      </div>
    </div>
  </div>

  <!-- Action buttons row -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="btn-toolbar">
        <div class="btn-group me-2">
          <button class="btn btn-outline-secondary" 
            (click)="backToBuckets()" i18n>
            <span class="material-icons align-text-bottom">arrow_back</span>
            Back to Buckets
          </button>
          <button *ngIf="bucketId" class="btn btn-outline-secondary" 
            (click)="viewBucketContent()" i18n>
            <span class="material-icons align-text-bottom">visibility</span>
            View Bucket Content
          </button>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-success" 
            [disabled]="!pendingList.length || !bucketId" 
            (click)="addToBucket()" i18n>
            <span class="material-icons align-text-bottom">add_circle</span>
            Add to Bucket
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search section -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-primary text-white" i18n>
          <span class="material-icons align-text-bottom me-1">search</span>
          Search for Patrons
        </div>
        <div class="card-body">
          <!-- Advanced search button -->
          <div class="mb-3">
            <button class="btn btn-primary w-100" (click)="openPatronSearch()" i18n>
              <span class="material-icons align-text-bottom">manage_search</span>
              Advanced Patron Search
            </button>
          </div>
          
          <!-- Barcode search -->
          <div class="mb-3">
            <label for="barcodeSearch" class="form-label" i18n>Search by Barcode</label>
            <div class="input-group">
              <input type="text" class="form-control" id="barcodeSearch"
                placeholder="Enter barcode" i18n-placeholder
                [(ngModel)]="barcodeString"
                (keyup.enter)="search()">
              <button class="btn btn-outline-secondary" type="button" 
                (click)="search()">
                <span class="material-icons">search</span>
              </button>
            </div>
          </div>
          
          <!-- Barcodes from file -->
          <div>
            <label for="barcodesFile" class="form-label" i18n>Or add barcodes from file (one per line)</label>
            <textarea class="form-control" id="barcodesFile" rows="3"
              [(ngModel)]="barcodesFromFile"></textarea>
            <div class="d-flex justify-content-end mt-2">
              <button class="btn btn-outline-primary" 
                (click)="processBarcodeFile()">
                <span class="material-icons align-text-bottom">upload_file</span>
                <span i18n>Process Barcodes</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending patrons section -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0" i18n>Pending Patrons</h4>
        <div>
          <button class="btn btn-danger me-2" 
            [disabled]="!pendingList.length" 
            (click)="resetPendingList()">
            <span class="material-icons align-text-bottom">clear_all</span>
            <span i18n>Clear List</span>
          </button>
          <button class="btn btn-success" 
            [disabled]="!pendingList.length || !bucketId" 
            (click)="addToBucket()">
            <span class="material-icons align-text-bottom">add_circle</span>
            <span i18n>Add to Bucket</span>
          </button>
        </div>
      </div>
      
      <eg-grid #grid idlClass="au"
          persistKey="circ.patron_bucket_pending"
          [dataSource]="dataSource"
          [showDeclaredFieldsOnly]="true"
          [sortable]="true" [filterable]="true">

        <eg-grid-column name="id" [index]="true" [hidden]="true"></eg-grid-column>
        <eg-grid-column name="barcode" path="card.barcode" [cellTemplate]="barcodeTemplate"></eg-grid-column>
        <eg-grid-column name="family_name"></eg-grid-column>
        <eg-grid-column name="first_given_name"></eg-grid-column>
        <eg-grid-column name="second_given_name"></eg-grid-column>
        <eg-grid-column name="home_ou.name" i18n-label label="Home Library"></eg-grid-column>
        <eg-grid-column name="actions" i18n-label label="Actions" [cellTemplate]="actionsTemplate" [sortable]="false"></eg-grid-column>
      </eg-grid>
    </div>
  </div>
</div>

<ng-template #barcodeTemplate let-row="row">
  <ng-container *ngIf="row.card && row.card.barcode">
    <a href="/eg2/staff/circ/patron/{{row.id}}?search=barcode&query={{row.card.barcode}}" target="_blank">
      {{row.card.barcode}}
    </a>
  </ng-container>
  <span *ngIf="!row.card || !row.card.barcode" class="text-muted" i18n>No barcode</span>
</ng-template>

<ng-template #actionsTemplate let-row="row">
  <button class="btn btn-sm btn-danger" 
    (click)="removeFromPendingList(row.id)" title="Remove from list" i18n-title>
    <span class="material-icons">remove_circle</span>
  </button>
</ng-template>
