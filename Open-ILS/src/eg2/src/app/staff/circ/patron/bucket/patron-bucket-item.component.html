<eg-title i18n-prefix prefix="Patron Bucket Content">
</eg-title>

<eg-staff-banner bannerText="Patron Bucket Content" i18n-bannerText>
</eg-staff-banner>

<eg-confirm-dialog #confirmDialog></eg-confirm-dialog>
<eg-alert-dialog #alertDialog></eg-alert-dialog>
<eg-bucket-dialog #addToBucketDialog></eg-bucket-dialog>
<eg-patron-bucket-add-dialog #addPatronDialog></eg-patron-bucket-add-dialog>

<div class="container-fluid px-0">
  <!-- Top navigation buttons -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="navigation-buttons">
        <a *ngIf="returnTo" class="btn btn-outline-secondary" 
          routerLink="/staff/circ/patron/bucket/{{returnTo}}" i18n>
          <span class="material-icons">arrow_back</span>
          Back to Buckets
        </a>
        <a *ngIf="!returnTo" class="btn btn-outline-secondary" 
          routerLink="/staff/circ/patron/bucket" i18n>
          <span class="material-icons">arrow_back</span>
          Back to Buckets
        </a>
      </div>
    </div>
  </div>

  <!-- Bucket header with information -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="bucket-header d-flex flex-wrap align-items-baseline">
        <h3 class="my-0 me-3">
          {{bucket?.name()}}
          <span *ngIf="bucketId" class="ms-2 text-muted" style="font-size: 1rem;">
            (ID: {{bucketId}})
          </span>
        </h3>
        <span class="me-3 text-muted" *ngIf="bucket?.owner()">
          <span i18n>Owner:</span>
          <a href="/eg2/staff/circ/patron/{{bucket?.owner()?.id()}}/edit" 
            target="_blank" class="ms-1">
            {{bucket?.owner()?.usrname()}}
          </a>
        </span>
        <span *ngIf="bucket?.description()" class="bucket-description text-muted">
          {{bucket?.description()}}
        </span>
      </div>
    </div>
  </div>

  <!-- Controls row - optimized for horizontal layout -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="action-controls-wrapper d-flex flex-wrap align-items-start">
        <!-- Left side controls -->
        <div class="me-auto d-flex flex-wrap">
          <!-- Patron actions group -->
          <div class="btn-group me-3 mb-2">
            <button class="btn btn-primary" 
              (click)="openAddPatronDialog()" i18n>
              <span class="material-icons">person_add</span>
              Add Patron
            </button>
            <a class="btn btn-outline-primary" 
              routerLink="/staff/circ/patron/bucket/add/{{bucketId}}" i18n>
              <span class="material-icons">group_add</span>
              Add Multiple Patrons
            </a>
          </div>
          
          <!-- Bulk actions dropdown, positioned horizontally with other controls -->
          <div ngbDropdown class="mb-2 me-3">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
              id="bulkActionsDropdown" ngbDropdownToggle>
              <span class="material-icons">build</span>
              <span i18n>Bulk Actions</span>
            </button>
            <div ngbDropdownMenu aria-labelledby="bulkActionsDropdown">
              <button ngbDropdownItem (click)="updateAllPatrons()" i18n>
                <span class="material-icons">group</span>
                Update All Patrons
              </button>
              <button ngbDropdownItem (click)="modifyStatcats()" i18n>
                <span class="material-icons">category</span>
                Modify Statistical Categories
              </button>
              <button ngbDropdownItem (click)="viewChangesets()" i18n>
                <span class="material-icons">history</span>
                View Changesets
              </button>
              <button ngbDropdownItem (click)="applyRollback()" i18n>
                <span class="material-icons">restore</span>
                Apply Rollback
              </button>
              <div class="dropdown-divider"></div>
              <button ngbDropdownItem class="text-danger" (click)="deleteAllPatrons()" i18n>
                <span class="material-icons">delete_forever</span>
                Delete All Patrons
              </button>
            </div>
          </div>
        </div>
        
        <!-- Right side controls - Quick add form -->
        <form class="quick-add-form mb-2" (ngSubmit)="quickAddPatron()">
          <div class="input-group">
            <input type="text" class="form-control" 
                  [(ngModel)]="quickAddBarcode" 
                  name="quickAddBarcode" 
                  placeholder="Scan Patron Barcode" i18n-placeholder
                  aria-label="Patron Barcode" i18n-aria-label
                  #barcodeInput>
            <button class="btn btn-outline-primary" type="submit" i18n>
              <span class="material-icons">qr_code_scanner</span>
              Quick Add
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Grid section - unchanged -->
  <div class="row">
    <div class="col-12">
      <eg-grid #grid idlClass="cubi" i18n-persistKey 
        persistKey="circ.patron_bucket_items"
        [dataSource]="dataSource" [cellTextGenerator]="cellTextGenerator"
        (rowSelectionChange)="gridSelectionChange($event)"
        [sortable]="true" [filterable]="true"
        ignoreFields="bucket">
        
        <eg-grid-toolbar-action label="Remove from Bucket" i18n-label
            [disabled]="noSelectedRows"
            (onClick)="removeFromBucket($event)"
            icon="delete">
        </eg-grid-toolbar-action>

        <eg-grid-toolbar-action label="Move to Another Bucket" i18n-label
            [disabled]="noSelectedRows"
            (onClick)="moveAddToBucket($event, true)"
            tooltip="Copy patrons to another bucket and remove from this bucket" i18n-tooltip
            icon="drive_file_move">
        </eg-grid-toolbar-action>

        <eg-grid-toolbar-action label="Copy to Another Bucket" i18n-label
            [disabled]="noSelectedRows"
            (onClick)="moveAddToBucket($event, false)"
            tooltip="Copy patrons to another bucket while keeping them in this bucket" i18n-tooltip
            icon="content_copy">
        </eg-grid-toolbar-action>

        <eg-grid-toolbar-action label="Edit Patron(s)" i18n-label
            [disabled]="noSelectedRows"
            (onClick)="editSelectedPatrons($event)"
            icon="edit">
        </eg-grid-toolbar-action>

        <eg-grid-column path="id" [index]="true" i18n-label label="ID" />
        <eg-grid-column name="barcode" path="target_user.card.barcode" i18n-label label="Barcode" [cellTemplate]="barcodeTemplate" />
        <eg-grid-column name="family_name" path="target_user.family_name" />
        <eg-grid-column name="first_given_name" path="target_user.first_given_name" />
        <eg-grid-column name="second_given_name" path="target_user.second_given_name" [hidden]="true" />
        <eg-grid-column name="home_ou.name" path="target_user.home_ou.name" i18n-label label="Home Library" />
        <eg-grid-column name="create_time" path="create_time" i18n-label label="Create Time" datatype="timestamp" />
        <eg-grid-column name="target_user" path="target_user" i18n-label label="Username" />
        <eg-grid-column name="pos" path="pos" i18n-label label="Position" [hidden]="true" />
      </eg-grid>
    </div>
  </div>
</div>

<ng-template #barcodeTemplate let-row="row">
  <a *ngIf="row.target_user?.card()?.barcode()" 
     href="/eg2/staff/circ/patron/{{row.target_user.id()}}/edit" 
     target="_blank"
     title="Edit Patron ({{row.target_user.card().barcode()}})">
    {{row.target_user.card().barcode()}}
  </a>
  <span *ngIf="!row.target_user?.card()?.barcode()">
    <em>No barcode</em>
  </span>
</ng-template>

<eg-progress-dialog #progressDialog></eg-progress-dialog>
