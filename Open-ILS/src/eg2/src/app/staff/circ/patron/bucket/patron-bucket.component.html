<eg-title i18n-prefix prefix="Patron Buckets">
</eg-title>

<eg-staff-banner bannerText="Patron Buckets" i18n-bannerText>
</eg-staff-banner>

<eg-confirm-dialog #deleteDialog i18n-dialogTitle dialogTitle="Delete Bucket">
</eg-confirm-dialog>

<eg-alert-dialog #deleteFail i18n-dialogTitle i18n-dialogBody 
  dialogTitle="Delete Failed" dialogBody="Bucket deletion failed">
</eg-alert-dialog>

<eg-alert-dialog #retrieveByIdFail i18n-dialogTitle 
  dialogTitle="Bucket Not Found">
</eg-alert-dialog>

<eg-fm-record-editor #editDialog idlClass="cub" readonlyFields="id,btype,create_time,owner">
</eg-fm-record-editor>

<eg-bucket-action-summary-dialog #results i18n-dialogTitle
  dialogTitle="Deletion Results">
</eg-bucket-action-summary-dialog>

<div class="container-fluid px-0">
  <div class="row mb-3">
    <div class="col-md-8">
      <ul class="nav nav-pills">
        <ng-container *ngFor="let view of getViewKeys()">
          <li class="nav-item">
            <button type="button" class="nav-link"
              [ngClass]="{'active': isCurrentView(view)}"
              (click)="switchTo(view)"
              [disabled]="views[view]['count'] <= 0"
              [attr.aria-current]="isCurrentView(view) ? 'page' : null">
              {{views[view].label}}
              <span class="badge bg-secondary ms-1">{{views[view]['count'] === -1 ? (countInProgress ? '...' : 0) : views[view]['count']}}</span>
            </button>
          </li>
        </ng-container>
      </ul>
    </div>
    <div class="col-md-4">
      <form class="input-group">
        <label for="bucket-id-input" class="input-group-text" i18n>Bucket ID:</label>
        <input type="text" class="form-control"
          id="bucket-id-input"
          name="bucket-id-input"
          [(ngModel)]="bucketIdToRetrieve"
          (keydown.enter)="retrieveBucketById()">
          <button class="btn btn-outline-secondary"
            (click)="retrieveBucketById()" i18n>
            Search
          </button>
      </form>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-12">
      <div class="btn-toolbar">
        <div class="btn-group me-2">
          <button class="btn btn-outline-primary" (click)="openNewBucketDialog()" i18n>
            <span class="material-icons align-text-bottom">add</span>
            New Bucket
          </button>
        </div>
        <div class="btn-group me-2">
          <a class="btn btn-outline-secondary" routerLink="/staff/circ/patron/bucket/add/{{bucketId}}" i18n>
            <span class="material-icons align-text-bottom">person_add</span>
            Add Patrons
          </a>
        </div>
        <div class="btn-group me-2">
          <button class="btn btn-outline-secondary" (click)="openSharedBucketDialog()" i18n>
            <span class="material-icons align-text-bottom">share</span>
            Load Shared Bucket
          </button>
        </div>
      </div>
    </div>
  </div>

  <eg-bucket-transfer-dialog #transferDialog></eg-bucket-transfer-dialog>
  <eg-bucket-share-dialog #shareBucketDialog></eg-bucket-share-dialog>
  
  <div class="row">
    <div class="col-12">
      <eg-grid #grid idlClass="cub"
          persistKey="circ.patron_buckets"
          [dataSource]="dataSource" [cellTextGenerator]="cellTextGenerator"
          (rowSelectionChange)="gridSelectionChange($event)"
          showDeclaredFieldsOnly="true"
          [sortable]="true" [filterable]="true" [allowNamedFilterSets]="false">

          <eg-grid-toolbar-button label="New Bucket" i18n-label
            (onClick)="openNewBucketDialog()">
          </eg-grid-toolbar-button>

          <eg-grid-toolbar-action
              label="Edit Bucket" i18n-label
              [disabled]="!oneSelectedRow"
              (onClick)="openEditBucketDialog($event)">
          </eg-grid-toolbar-action>

          <eg-grid-toolbar-action
              label="Delete Bucket(s)" i18n-label
              [disabled]="noSelectedRows"
              (onClick)="openDeleteBucketDialog($event)">
          </eg-grid-toolbar-action>

          <eg-grid-toolbar-action
              label="Transfer Bucket Ownership" i18n-label
              [disabled]="noSelectedRows"
              (onClick)="openTransferDialog($event)">
          </eg-grid-toolbar-action>

          <eg-grid-toolbar-action
              label="Share Bucket" i18n-label
              [disabled]="noSelectedRows"
              (onClick)="openShareBucketDialog($event)">
          </eg-grid-toolbar-action>

          <eg-grid-column path="id"></eg-grid-column>
          <eg-grid-column path="name" [cellTemplate]="nameTemplate"></eg-grid-column>
          <eg-grid-column path="description"></eg-grid-column>
          <eg-grid-column path="btype"></eg-grid-column>
          <eg-grid-column path="owner.usrname" i18n-label label="Owner"></eg-grid-column>
          <eg-grid-column path="create_time"></eg-grid-column>
          <eg-grid-column name="row-actions" label="Actions" i18n-label [filterable]="false" 
            [sortable]="false" [cellTemplate]="bucketActionsTemplate"></eg-grid-column>
      </eg-grid>
    </div>
  </div>
</div>

<ng-template #nameTemplate let-r="row">
  <a routerLink="/staff/circ/patron/bucket/content/{{r?.bucket?.id}}" [queryParams]="{returnTo: currentView}">{{r?.bucket?.name}}</a>
</ng-template>

<ng-template #bucketActionsTemplate let-row="row">
  <div class="hstack flex-wrap justify-content-end">
    <div class="hstack flex-wrap">
      <a class="btn mat-icon-in-button bucket-action" routerLink="/staff/circ/patron/bucket/add/{{row?.bucket?.id}}">
        <span class="visually-hidden" id="actions-add-patrons-{{row?.bucket?.id}}" i18n>Add Patrons to {{row?.bucket?.name}}</span>
        <span class="material-icons" aria-hidden="true" title="Add Patrons" i18n-title>person_add</span>
      </a>
      <button type="button" class="btn mat-icon-in-button bucket-action" (click)="openEditBucketDialog([row])">
        <span class="visually-hidden" id="actions-edit-bucket-{{row?.bucket?.id}}" i18n>Edit {{row?.bucket?.name}}</span>
        <span class="material-icons" aria-hidden="true" title="Edit {{row?.bucket?.name}}" i18n-title>edit</span>
      </button>
    </div>
    <div class="hstack flex-wrap">
      <button type="button" class="btn mat-icon-in-button bucket-action" (click)="openShareBucketDialog([row])">
        <span class="visually-hidden" id="actions-share-bucket-{{row?.bucket?.id}}" i18n>Share {{row?.bucket?.name}}</span>
        <span class="material-icons" aria-hidden="true" title="Share {{row?.bucket?.name}}" i18n-title>share</span>
      </button>
      <button type="button" class="btn mat-icon-in-button bucket-action bucket-destroy" (click)="openDeleteBucketDialog([row])">
        <span class="visually-hidden" id="actions-delete-bucket-{{row?.bucket?.id}}" i18n>Delete {{row?.bucket?.name}}</span>
        <span class="material-icons" aria-hidden="true" title="Delete {{row?.bucket?.name}}" i18n-title>delete</span>
      </button>
    </div>
  </div>
</ng-template>
