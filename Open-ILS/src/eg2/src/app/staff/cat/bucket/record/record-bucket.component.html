<eg-title i18n-prefix prefix="Record Buckets">
</eg-title>

<eg-staff-banner bannerText="Bibliographic Record Buckets" i18n-bannerText>
</eg-staff-banner>

<ng-template #bannerTemplate>
    <button type="button" class="btn btn-sm btn-primary" (click)="openNewBucketDialog($event)" i18n>New Bucket</button>
</ng-template>

<eg-bucket-dialog #newBucketDialog bucketClass="biblio" [showPublicOption]="true"></eg-bucket-dialog>

<eg-fm-record-editor #editDialog idlClass="cbreb" readonlyFields="id,btype,create_time,owner,owning_lib">
</eg-fm-record-editor>

<eg-alert-dialog #deleteFail i18n-dialogTitle
  dialogTitle="Could not delete bucket(s).">
</eg-alert-dialog>

<eg-alert-dialog #retrieveByIdFail i18n-dialogTitle
  dialogTitle="Could not retrieve the bucket referenced.">
</eg-alert-dialog>

<eg-alert-dialog #createCarouselFail i18n-dialogTitle
  dialogTitle="Could not create a carousel from the bucket referenced.">
</eg-alert-dialog>

<eg-confirm-dialog #deleteDialog
  i18n-dialogTitle
  dialogTitle="Delete selected container(s)?">
</eg-confirm-dialog>

<eg-confirm-dialog #deleteCarouselDialog
  i18n-dialogTitle
  dialogTitle="Delete carousel buckets and their carousels?">
</eg-confirm-dialog>

<eg-bucket-action-summary-dialog #results i18n-dialogTitle
  dialogTitle="Deletion Results">
</eg-bucket-action-summary-dialog>

<eg-prompt-dialog #createCarouselPrompt
  i18n-dialogBody dialogBody="Enter a name for the new carousel:"
  i18n-dialogTitle dialogTitle="Create Carousel"
  i18n-confirmString confirmString="Create">
</eg-prompt-dialog>

<eg-record-bucket-export-dialog #exportDialog>
</eg-record-bucket-export-dialog>

<eg-record-bucket-item-upload-dialog #importDialog>
</eg-record-bucket-item-upload-dialog>

<div class="container-fluid px-0">
  <div class="row mb-3">
    <div class="col-12">
      <div class="d-flex flex-wrap align-items-center justify-content-between">
        <!-- Left side with New Bucket button and tabs -->
        <div class="bucket-controls d-flex flex-wrap align-items-center">
          <button class="btn btn-primary me-3 mb-2" (click)="openNewBucketDialog($event)">
            <span class="material-icons">add</span>
            <span i18n>New Bucket</span>
          </button>
          
          <!-- Tabs navigation, converted from filter links -->
          <ul class="nav nav-tabs mb-2">
            <ng-container *ngFor="let view of getViewKeys()">
              <ng-container *ngIf="views[view].label !== null">
                <li class="nav-item">
                  <a class="nav-link" [class.active]="isCurrentView(view)" (click)="switchTo(view)"
                    [attr.aria-current]="isCurrentView(view) ? 'page' : null">
                    <span class="material-icons" *ngIf="view === 'all'">visibility</span>
                    <span class="material-icons" *ngIf="view === 'user'">folder</span>
                    <span class="material-icons" *ngIf="view === 'favorites'">star</span>
                    <span class="material-icons" *ngIf="view === 'recent'">history</span>
                    <span class="material-icons" *ngIf="view === 'shared_with_others'">share</span>
                    <span class="material-icons" *ngIf="view === 'shared_with_user'">folder_shared</span>
                    {{views[view].label}}
                    <span class="tab-count">
                      ({{views[view]['count'] === -1 ? (countInProgress ? '...' : 0) : views[view]['count']}})
                    </span>
                  </a>
                </li>
              </ng-container>
            </ng-container>
          </ul>
        </div>
        
        <!-- Right side with search form -->
        <div class="d-flex flex-wrap">
          <!-- Bucket ID Retrieval Form -->
          <form class="retrieve-form me-2 mb-2">
            <div class="input-group">
              <label for="bucketIdInput" class="input-group-text" i18n>Bucket ID:</label>
              <input id="bucketIdInput" class="form-control" type="text" inputmode="numeric" 
                [(ngModel)]="bucketIdToRetrieve" name="bucketIdToRetrieve" (keydown.enter)="retrieveBucketById()" />
              <button type="button" class="btn btn-outline-primary" (click)="retrieveBucketById()" i18n>Retrieve</button>
            </div>
          </form>
          
          <!-- Catalog Search Form -->
          <form class="mb-2">
            <div class="input-group">
              <input type="text" class="form-control"
                [(ngModel)]="catSearchQuery"
                id="catalog-search-input"
                name="catalog-search-input"
                i18n-placeholder placeholder="Search for..."
                i18n-aria-label aria-label="Search for...">
              <button class="btn btn-outline-primary" type="button"
                (click)="searchCatalog()" i18n>Search Catalog</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <eg-bucket-transfer-dialog #transferDialog></eg-bucket-transfer-dialog>
  <eg-bucket-share-dialog #shareBucketDialog bucketClass="biblio"></eg-bucket-share-dialog>

  <eg-grid #grid idlClass="cbreb"
      persistKey="catalog.record_buckets"
      [dataSource]="dataSource" [cellTextGenerator]="cellTextGenerator"
      (rowSelectionChange)="gridSelectionChange($event)"
      showDeclaredFieldsOnly="true"
      [sortable]="true" [filterable]="true" [allowNamedFilterSets]="false">

    <eg-grid-toolbar-action
        label="Edit Bucket" i18n-label
        [disabled]="!oneSelectedRow"
        (onClick)="openEditBucketDialog($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Add to Favorites" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="favoriteBucket($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Remove from Favorites" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="unFavoriteBucket($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Delete Bucket(s)" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="openDeleteBucketDialog($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="MARC Batch Edit" i18n-label
        [disabled]="!oneSelectedRow"
        (onClick)="marcBatchEdit($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Create Carousel From Bucket" i18n-label
        [disabled]="!oneSelectedRow"
        (onClick)="openCreateCarouselDialog($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Transfer Bucket Ownership" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="openTransferDialog($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Share Bucket" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="openShareBucketDialog($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Upload Records" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="uploadRecords($event)">
    </eg-grid-toolbar-action>

    <eg-grid-toolbar-action
        label="Export Records" i18n-label
        [disabled]="noSelectedRows"
        (onClick)="exportAllRecords($event)">
    </eg-grid-toolbar-action>

    <eg-grid-column name="favorite" label="Favorite" i18n-label [filterable]="false" [sortable]="false" [cellTemplate]="favoriteCellTemplate"></eg-grid-column>
    <eg-grid-column [required]="true" path="id" [index]="true"></eg-grid-column>
    <eg-grid-column [required]="true" name="name" [cellTemplate]="nameTemplate"></eg-grid-column>
    <eg-grid-column [required]="true" path="description"></eg-grid-column>
    <eg-grid-column [required]="true" [sortable]="false" path="item_count" i18n-label label="# of entries"></eg-grid-column>
    <eg-grid-column [required]="true" [sortable]="false" path="org_share_count" i18n-label label="# of org shares"></eg-grid-column>
    <eg-grid-column [required]="true" [sortable]="false" path="usr_view_share_count" i18n-label label="# of user view shares"></eg-grid-column>
    <eg-grid-column [required]="true" [sortable]="false" path="usr_edit_share_count" i18n-label label="# of user edit shares"></eg-grid-column>
    <eg-grid-column [required]="true" path="btype"></eg-grid-column>
    <eg-grid-column [required]="true" path="pub"></eg-grid-column>
    <eg-grid-column [required]="true" path="create_time"></eg-grid-column>
    <eg-grid-column [required]="true" name="owner" path="owner.usrname" i18n-label label="Owner" idlClass="au" [hidden]="true"></eg-grid-column>
    <eg-grid-column [required]="true" name="owning_lib" path="owning_lib.shortname" i18n-label label="Owning Lib" idlClass="aou" [hidden]="true"></eg-grid-column>
    <eg-grid-column [required]="true" name="row-actions" label="Actions" i18n-label [filterable]="false" 
      [sortable]="false" [cellTemplate]="bucketActionsTemplate"></eg-grid-column>
  </eg-grid>

  <ng-template #favoriteCellTemplate let-row="row">
    <button *ngIf="row?.favorite" (click)="unFavoriteBucket([row])"
      type="button" class="btn mat-icon-in-button text-warning user-favorite">
      <span class="material-icons" title="Favorite" i18n-title aria-hidden="true">star</span>
      <span class="visually-hidden" i18n="Bucket favorites column star icon alt text">Favorite</span>
    </button>
    <button *ngIf="!row?.favorite" (click)="favoriteBucket([row])"
      type="button" class="btn mat-icon-in-button text-muted user-favorite">
      <span class="material-icons" title="Not favorite" i18n-title aria-hidden="true">star_outlined</span>
      <span class="visually-hidden" i18n="Bucket favorites column star icon alt text">Not favorite</span>
    </button>
  </ng-template>

  <ng-template #nameTemplate let-r="row">
    <a routerLink="/staff/cat/bucket/record/content/{{r?.id}}" 
       [queryParams]="{returnTo: currentView}"
       class="bucket-name-link">{{r?.name}}</a>
  </ng-template>

  <ng-template #bucketActionsTemplate let-row="row">
    <div class="hstack flex-wrap justify-content-end">
      <div class="hstack flex-wrap">
        <button type="button" class="btn mat-icon-in-button bucket-action" (click)="openEditBucketDialog([row])">
          <span class="visually-hidden" id="actions-edit-bucket-{{row?.id}}" i18n>Edit {{row?.name}}</span>
          <span class="material-icons" aria-hidden="true" title="Edit {{row?.name}}" i18n-title>edit</span>
        </button>
      
        <button type="button" class="btn mat-icon-in-button bucket-action" (click)="openCreateCarouselDialog([row])">
          <span class="visually-hidden" id="actions-add-carousel-{{row?.id}}" i18n>Create carousel from {{row?.name}}</span>
          <span class="material-icons" aria-hidden="true" title="Create carousel from {{row?.name}}" i18n-title>add_photo_alternate</span>
        </button>
      </div>
      <div class="hstack flex-wrap">
        <button type="button" class="btn mat-icon-in-button bucket-action" (click)="openShareBucketDialog([row])">
          <span class="visually-hidden" id="actions-share-bucket-{{row?.id}}" i18n>Share {{row?.name}}</span>
          <span class="material-icons" aria-hidden="true" title="Share {{row?.name}}" i18n-title>account_circle</span>
        </button>
        <button type="button" class="btn mat-icon-in-button bucket-action bucket-destroy" (click)="openDeleteBucketDialog([row])">
          <span class="visually-hidden" id="actions-delete-bucket-{{row?.id}}" i18n>Delete {{row?.name}}</span>
          <span class="material-icons" aria-hidden="true" title="Delete {{row?.name}}" i18n-title>close</span>
        </button>
      </div>
    </div>
  </ng-template>

  <eg-patron-search-dialog #patronSearch></eg-patron-search-dialog>
</div>
